<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Creating basic cartographies</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Fighting for our lives: Accompanying website</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="Cartography.html">Producing basic cartographies</a>
</li>
<li>
  <a href="Links.html">Quantitative Analysis</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Creating basic cartographies</h1>

</div>


<p>We start by loading libraries</p>
<pre class="r"><code>library(tidyverse)
library(sf)
library(ggspatial)
library(readxl)
library(writexl)
library(sf)
library(tidygeocoder)</code></pre>
<div id="creating-maps-with-already-existing-geospatial-information." class="section level1">
<h1>1 Creating maps with already existing geospatial information.</h1>
<p>The first data sets we will load are shapefiles. Shapefiles are geospatial datasets that contains the necessary information to produce maps.</p>
<p>The first dataset we will load is from the Spanish Institue of Geography. It contains data on the legal limits of Spain’s autonomous communities.I obtained this data set form the open data repository of CLM’s government. We will load it and use it as our basic cartography of CLM’s provinces.</p>
<p>#Data for the autonomous communities.</p>
<p>We start by reading the shapefile.</p>
<pre class="r"><code>CCAA &lt;- st_read(&quot;data/recintos_autonomicas_inspire_peninbal_etrs89.shp&quot;)</code></pre>
<pre><code>## Reading layer `recintos_autonomicas_inspire_peninbal_etrs89&#39; from data source 
##   `C:\Victor\KCL\Thesis\R\Website\Fighting_for_our_lives_MA_Thesis\data\recintos_autonomicas_inspire_peninbal_etrs89.shp&#39; 
##   using driver `ESRI Shapefile&#39;
## Simple feature collection with 20 features and 9 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -9.301516 ymin: 35.17045 xmax: 4.327785 ymax: 43.79238
## Geodetic CRS:  ETRS89</code></pre>
<p>Just to check that our data set is properly loaded, let’s make our first map!</p>
<pre class="r"><code>ggplot()+# We are asking R to use the ggplot tools to produce a visualization
  geom_sf(data = CCAA, aes(fill=))+# We are asking R to
  annotation_north_arrow(location=&quot;br&quot;, which_nort=TRUE,# Here we are adding
                         #a north facing arrow to make the map more 
                         #readable. We are telling r to place it in the
                         #bottom right hand side (&quot;br&quot;) and use the real
                         #north as a point of reference.
                         style = north_arrow_fancy_orienteering(), 
                         #this is a mere stylistic decision. I am asking R to
                         #use the style north_arrow_fancy_orienteering
                         #because I like how it looks.
                         height = unit(2.5, &quot;cm&quot;),# We specify the arrow&#39;s
                         #height to 2.5cm.
                         width = unit(2.5, &quot;cm&quot;))+# We specify the arrow&#39;s
                         #width to 2.5cm.
  annotation_scale()# Lastly, this piece of automatically calculates</code></pre>
<p><img src="Cartography_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<pre class="r"><code>  #our map&#39;s scale.</code></pre>
<p>It works! We have a map. Now we have to make the dataset more operable. Remember that our goal is to create a map that situates CLM within Spain. Thus, we will look at the column NATCODE. The NATCODE is a string of numbers containing information about several geographic features. For instance, the first two characters of a NATCODE tell us which country a given feature belongs to, whereas the third and fourth characters tell us which autonomous community is a given place part of. Using this information, I will break down the column NATCODE and create new columns identifying the country, autonomous community, province and municipilaty of our data. I promise this is the hardest bit we will do in this website!</p>
<pre class="r"><code>CCAA_2&lt;- CCAA%&gt;%
  mutate(
    c_country       = str_sub(string = NATCODE, start = 1, end = 2),
    c_CCAA = str_sub(string = NATCODE, start = 3, end = 4),
    c_province  = str_sub(string = NATCODE, start = 5, end = 6),
    cod_ine_municipality  = str_sub(string = NATCODE, start = 7, end = -1))
names(CCAA_2)</code></pre>
<pre><code>##  [1] &quot;INSPIREID&quot;            &quot;COUNTRY&quot;              &quot;NATLEV&quot;              
##  [4] &quot;NATLEVNAME&quot;           &quot;NATCODE&quot;              &quot;NAMEUNIT&quot;            
##  [7] &quot;CODNUT1&quot;              &quot;CODNUT2&quot;              &quot;CODNUT3&quot;             
## [10] &quot;geometry&quot;             &quot;c_country&quot;            &quot;c_CCAA&quot;              
## [13] &quot;c_province&quot;           &quot;cod_ine_municipality&quot;</code></pre>
<p>Now that we have split the NATCODE and created a new column where each Autonomous Community has its own code, we can situate CLM within Spain.</p>
<p>Firstly, we will create a very simple object containing only the data for CLM. It will be called “castilla_la_mancha”</p>
<pre class="r"><code>castilla_la_mancha &lt;- CCAA_2%&gt;% #Here we are asking R to create a new object by looking at
  #the data frame &quot;CCAA_2&quot;.
    filter(c_CCAA == &quot;08&quot;) # And this code could be read by a human as: &quot;Out of the data frame
# CCAA_2, look for every instance where 08 (CLM&#39;s code) appeared in the c_CCAA column&quot;. </code></pre>
<p>After creating an object containing the data frame for CLM, we can plot it on top of our previous map!</p>
<pre class="r"><code>ggplot()+
  geom_sf (data = CCAA_2, aes(fill=NULL))+ #Use the data frame CCAA_2 to build our basic map
  geom_sf (data = castilla_la_mancha , aes(fill=&quot;red&quot;))+ #paint the object
  #contained in castilla_la_mancha (CLM&#39;s space) in red
  annotation_north_arrow(location=&quot;tr&quot;, which_north=TRUE,# 
                         style = north_arrow_fancy_orienteering(),
                         height = unit(2, &quot;cm&quot;),
                         width = unit(2, &quot;cm&quot;))+
  annotation_scale() +
   guides(fill = FALSE)+ #Here I am asking R not to show a label specifying the color
  theme(axis.text = element_blank(), #This part gets rid of the coordinates to make a clearer map,
        #I decided to do so in this map because providing precise geospatial information is not
        #as important in the maps plotting macrogranjas
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank())</code></pre>
<p><img src="Cartography_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>We are done with out first map! Now, let’s figure out where are CLM’s provinces ;)</p>
<p>#Data for the provinces within Spain.</p>
<p>Once again, the first step is to load the corresponding shapefile.</p>
<pre class="r"><code>CLM_provinces &lt;- st_read(&quot;data/Provincias.shp&quot;) </code></pre>
<pre><code>## Reading layer `Provincias&#39; from data source 
##   `C:\Victor\KCL\Thesis\R\Website\Fighting_for_our_lives_MA_Thesis\data\Provincias.shp&#39; 
##   using driver `ESRI Shapefile&#39;
## Simple feature collection with 5 features and 7 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -5.405995 ymin: 38.02244 xmax: -0.9159556 ymax: 41.32763
## Geodetic CRS:  WGS 84</code></pre>
<p>Great! We have loaded our spatial data set. Please note that the data set is in Spanish, we will fix that in two steps.</p>
<p>The first step is optional, we are converting our geospatial data into a data frame.</p>
<pre class="r"><code>CLM_provinces_df &lt;- fortify(CLM_provinces) #This piece of code turns our spatial data set into
# a data frame. A light kind of dataset that R works very well with. You can ommit this step
# if you want to. I did this because my laptop&#39;s computing power is not the greastest one ever.</code></pre>
<p>Now, comes the most interesting part. We are changing the name of one of the columns that we need to use later on.</p>
<pre class="r"><code>CLM_provinces_df &lt;- rename(CLM_provinces_df, 
       Province = NOMBRE) #We are asking R to rename the column &quot;NOMBRE&quot; (name is Spanish) as
# &quot;Province&quot;, this will come in handy for our next map.</code></pre>
<p>Lastly, we just have to make a map of CLM’s provinces</p>
<pre class="r"><code>CLM_provinces_df %&gt;%
  ggplot(aes(fill=Province, ))+
  scale_fill_brewer(palette = &quot;Reds&quot;) +
  geom_sf(color = &quot;black&quot;, size = 0.1)+
  theme(axis.text = element_blank(),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_blank(),
    panel.grid = element_blank(),
    axis.title = element_blank())</code></pre>
<p><img src="Cartography_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
<div id="creating-maps-with-new-geospatial-information." class="section level1">
<h1>2 Creating maps with new geospatial information.</h1>
<p>So far we have produced maps with existing information. Now let’s produce map to locate the existing macrogranjas in CLM and the projected ones.</p>
<p>#Map of the existing macrogranjas.</p>
<p>First of all, we will load an excel file containing the farms that in 2019 had at least 2000 pigs.</p>
<pre class="r"><code>villages_macrogranjas &lt;- read_excel(&quot;data/porcino +2000.xlsx&quot;)</code></pre>
<p>Now, we will clean our data set. Since some of the municipalities’ name include articles, we will get rid of them with the following line of code</p>
<pre class="r"><code>villages_macrogranjas_municipality_split &lt;- villages_macrogranjas %&gt;% 
  separate(Municipality,c(&quot;MUNICIPIO&quot;,&quot;ARTICLE&quot;),sep=&quot;,&quot;)</code></pre>
<p>Note that the excel we are working with does not have coordinates, just the name of villages. We will use the package tidygeocoder to use data from OpenStreetMaps as to geocode our data automatically. There are other options to geocode municipalities automatically, GoogleMaps being one of them. However, since 2018 Google changed their terms of service and prevents users to connect to their API to produce and publish geospatial information. Hence, we are using OpenStreetMaps, an open-source project. Out of respect to the people at OpenStreetMaps we are setting a minimum time of 2 seconds between each request (each search of each municipality) to prevent overloading their service. It will take a while, so feel free to grab a cup of tea on the meantime.</p>
<pre class="r"><code>villages_geocoded &lt;- villages_macrogranjas_municipality_split %&gt;%
  geocode(&quot;MUNICIPIO&quot;, method = &#39;osm&#39;, lat = latitude , long = longitude, min_time=2)</code></pre>
<p>Now we just have to plot our data in a new map!</p>
<pre class="r"><code>CLM_provinces %&gt;%
  ggplot(aes(&quot;gray33&quot;))+
  geom_sf(color = &quot;black&quot;, size = 0.1) +
  geom_point(data=villages_geocoded, aes(x=longitude, y=latitude, size=Animals, colour=&quot;pink&quot;, alpha=0.01)) +
  annotation_scale(location = &quot;br&quot;, width_hint = 0.5) +
  annotation_north_arrow(location = &quot;br&quot;, which_north = &quot;true&quot;, 
                         pad_x = unit(0.75, &quot;in&quot;), pad_y = unit(0.5, &quot;in&quot;),
                         style = north_arrow_fancy_orienteering) +
  coord_sf(xlim = c(-5.5, -0.5), ylim = c(38, 41.30)) +
  guides(colour = FALSE, alpha = FALSE)+
  xlab(&quot;Longitude&quot;)+
  ylab(&quot;Latitude&quot;)</code></pre>
<p><img src="Cartography_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p>Here is our map!</p>
<p>#Map of projected macrogranjas.</p>
<p>Now, let’s create our last map. We will follow the same steps that we did above. I obtained the information from NEVIA in early August 2021. By the time you are reading this, there is a good chance the data is outdated.</p>
<pre class="r"><code>projected_macrogranjas &lt;- read_excel(&quot;data/projected_macrogranjas_clean.xlsx&quot;)</code></pre>
<p>Just as before, our dataset lacks geospatial coordinates. Fear not, OpenStreetMaps will rescue us once again.</p>
<pre class="r"><code>projected_macrogranjas_geocoded &lt;- projected_macrogranjas %&gt;%
  geocode(&quot;Municipality&quot;, method = &#39;osm&#39;, lat = latitude , long = longitude, min_time=2)</code></pre>
<p>The last step left to do is to plot our information into a 4th map.</p>
<pre class="r"><code>CLM_provinces %&gt;%
  ggplot(aes(&quot;gray33&quot;))+
  geom_sf(color = &quot;black&quot;, size = 0.1) +
  geom_point(data=projected_macrogranjas_geocoded, colour=&quot;purple3&quot;, aes(x=longitude, y=latitude, alpha=0.01)) +
  annotation_scale(location = &quot;br&quot;, width_hint = 0.5) +
  annotation_north_arrow(location = &quot;br&quot;, which_north = &quot;true&quot;, 
                         pad_x = unit(0.75, &quot;in&quot;), pad_y = unit(0.5, &quot;in&quot;),
                         style = north_arrow_fancy_orienteering) +
  coord_sf(xlim = c(-5.5, -0.5), ylim = c(38, 41.30)) +
  guides(colour = FALSE, alpha = FALSE)+
  xlab(&quot;Longitude&quot;)+
  ylab(&quot;Latitude&quot;)</code></pre>
<p><img src="Cartography_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>And here it is! We are done with our cartographic production!</p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
